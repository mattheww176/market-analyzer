<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .analysis-output {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f3f4f6;
            padding: 1.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            transition: all 0.3s ease;
        }
        .loading {
            display: none;
        }
        
        /* Chart styles */
        #stockChart {
            width: 100% !important;
            height: 100% !important;
            min-height: 400px;
        }
        
        /* Analysis cards */
        .analysis-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .dark .analysis-card {
            background: #1f2937;
            border-color: #374151;
        }
        
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Tab styles */
        .chart-tab {
            transition: all 0.2s ease;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .chart-tab:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -1px;
            left: 0;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .chart-tab.active:after {
            width: 100%;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Dark mode styles */
        .dark .analysis-output {
            background-color: #1f2937;
            color: #f8fafc;  /* Brighter text for better readability */
        }
        
        .dark body {
            background-color: #111827;
            color: #f8fafc;  /* Brighter base text color */
        }
        
        .dark .bg-white {
            background-color: #1f2937;
        }
        
        /* Input field styles for dark mode */
        .dark input[type="text"],
        .dark input[type="number"],
        .dark select,
        .dark textarea {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563 !important;
        }
        
        .dark input[type="text"]::placeholder,
        .dark input[type="number"]::placeholder {
            color: #9ca3af !important;
        }
        
        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-600 {
            color: #f1f5f9;  /* Brighter text for better contrast */
        }
        
        .dark .text-gray-400,
        .dark .text-gray-500 {
            color: #cbd5e1;  /* Brighter secondary text */
        }
        
        .dark .bg-gray-100,
        .dark .bg-gray-50 {
            background-color: #1f2937;
        }
        
        /* Enhance contrast for better readability */
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: #374151;
        }
        
        .dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen transition-colors duration-200">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm dark:bg-gray-800 transition-colors duration-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-blue-600 dark:text-blue-400">📈 Market Analyzer</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="watchlistButton" class="relative p-2 text-gray-600 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 focus:outline-none group">
                        <i class="fas fa-star text-xl"></i>
                        <span id="watchlistCount" class="absolute -top-1 -right-1 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        <span class="absolute z-10 right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 hidden group-hover:block">
                            <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700">
                                <span>Your Watchlist</span>
                            </div>
                            <div id="watchlistItems" class="max-h-60 overflow-y-auto">
                                <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                                    No stocks in watchlist
                                </div>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-2">
                                <button id="clearWatchlist" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400">
                                    Clear All
                                </button>
                            </div>
                        </span>
                    </button>
                    <button id="themeToggle" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-moon text-gray-600 dark:text-yellow-300 text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Stock Analysis Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-400">Get detailed technical analysis and performance metrics</p>
        </header>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 transition-colors duration-200">
            <form id="analysisForm" class="space-y-6" novalidate>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Stock Ticker Input -->
                    <div class="space-y-2">
                        <label for="ticker" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Stock Ticker
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative mt-1 rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-chart-line text-gray-400"></i>
                            </div>
                            <input type="text" 
                                   id="ticker" 
                                   name="ticker" 
                                   placeholder="e.g., AAPL, MSFT, GOOG" 
                                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                                   autocomplete="off"
                                   autocapitalize="characters"
                                   maxlength="10">
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter a valid stock ticker symbol</p>
                    </div>
                    
                    <!-- Analysis Period -->
                    <div class="space-y-2">
                        <label for="days" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Analysis Period
                        </label>
                        <div class="relative mt-1">
                            <select id="days" 
                                    name="days" 
                                    class="block w-full pl-3 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                <option value="30">1 Month</option>
                                <option value="90" selected>3 Months</option>
                                <option value="180">6 Months</option>
                                <option value="365">1 Year</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <i class="fas fa-calendar-alt text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Days Input (initially hidden) -->
                    <div id="customDaysContainer" class="hidden space-y-2">
                        <label for="customDays" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Custom Days (1-365)
                        </label>
                        <input type="number" 
                               id="customDays" 
                               name="customDays" 
                               min="1" 
                               max="365" 
                               value="90"
                               class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <!-- Analysis Type -->
                    <div class="space-y-2">
                        <span class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Analysis Type
                        </span>
                        <div class="mt-1 space-y-2">
                            <div class="flex items-center">
                                <input id="analysis-basic" name="analysisType" type="radio" value="basic" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700" checked>
                                <label for="analysis-basic" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                    Basic Analysis
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="analysis-technical" name="analysisType" type="radio" value="technical" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                                <label for="analysis-technical" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                    Technical Analysis
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="analysis-full" name="analysisType" type="radio" value="full" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                                <label for="analysis-full" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                    Full Analysis
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Options -->
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="show-charts" name="showCharts" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded" checked>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="show-charts" class="font-medium text-gray-700 dark:text-gray-300">Show Interactive Charts</label>
                                <p class="text-gray-500 dark:text-gray-400">Display price and volume charts</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="email-report" name="emailReport" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="email-report" class="font-medium text-gray-700 dark:text-gray-300">Email me the report</label>
                                <p class="text-gray-500 dark:text-gray-400">Get a detailed report in your inbox</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <button type="button" 
                                class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-history mr-2"></i>
                            View History
                        </button>
                        <div class="flex space-x-3">
                            <button type="reset" 
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Reset
                            </button>
                            <button type="submit" 
                                    class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                                <i class="fas fa-chart-bar mr-2"></i>
                                Analyze Stock
                                <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="loading" class="text-center py-8 loading hidden">
            <div class="inline-flex items-center justify-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <div>
                    <p class="text-gray-700 dark:text-gray-300 font-medium">Analyzing stock data...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="loadingStatus">Fetching latest market data</p>
                </div>
            </div>
        </div>

        <div id="results" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 hidden transition-all duration-300">
            <!-- Stock Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white" id="stockTicker">BBAI</h2>
                        <span class="ml-3 px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200">
                            NASDAQ
                        </span>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mt-1" id="companyName">BigBear.ai Holdings, Inc.</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="addToWatchlistBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-yellow-500 dark:text-gray-400 dark:hover:text-yellow-400 transition-colors" title="Add to watchlist">
                        <i class="far fa-star text-xl"></i>
                    </button>
                    <button id="exportPdf" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400" title="Export to PDF">
                        <i class="fas fa-file-pdf text-lg"></i>
                    </button>
                    <button id="exportCsv" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-green-500 dark:text-gray-400 dark:hover:text-green-400" title="Export to CSV">
                        <i class="fas fa-file-csv text-lg"></i>
                    </button>
                    <button id="printResults" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-blue-500 dark:text-gray-400 dark:hover:text-blue-400" title="Print">
                        <i class="fas fa-print text-lg"></i>
                    </button>
                </div>
            </div>
            
            <!-- Price and Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Current Price Card -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-xl border border-blue-100 dark:border-blue-800/30">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="stockSymbol" class="text-xl font-bold text-gray-900 dark:text-white">-</h3>
                            <p id="stockName" class="text-sm text-gray-500 dark:text-gray-400">-</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center mt-4 md:mt-0 w-full md:w-auto">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Current</p>
                            <p id="currentPrice" class="text-lg font-semibold text-gray-900 dark:text-white">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Change</p>
                            <p id="priceChange" class="text-lg font-semibold">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">% Change</p>
                            <p id="percentChange" class="text-lg font-semibold">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart Tabs -->
            <div class="mb-6">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="price" class="tab-button border-blue-500 text-blue-600 dark:text-blue-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Price Chart
                        </button>
                        <button data-tab="volume" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Volume
                        </button>
                        <button data-tab="rsi" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            RSI
                        </button>
                        <button data-tab="macd" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            MACD
                        </button>
                    </nav>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="relative h-96 mb-6">
                <canvas id="stockChart"></canvas>
                <div id="chartLoading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-gray-800/80 hidden">
                </div>
            </div>

            <!-- Technical Analysis Section -->
            <div id="technicalAnalysisSection" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                    Technical Analysis
                </h3>
                
                <div class="space-y-6">
                    <!-- RSI Analysis -->
                    <div class="analysis-card">
                        <div class="flex items-center justify-between cursor-pointer" data-toggle="rsi-analysis">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                    <i class="fas fa-wave-square text-blue-500"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">RSI Analysis</h4>
                            </div>
                            <div class="flex items-center">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 mr-3">
                                    Oversold
                                </span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform" id="rsi-arrow"></i>
                            </div>
                        </div>
                        <div id="rsi-analysis" class="mt-4 pl-13 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Current RSI</p>
                                    <div class="flex items-baseline">
                                        <span class="text-2xl font-bold text-gray-900 dark:text-white">25.6</span>
                                        <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">/ 70</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">14-Day Average</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">32.4</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Signal Strength</p>
                                    <div class="flex items-center">
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 mr-2">
                                            <div class="bg-red-500 h-2.5 rounded-full" style="width: 36.6%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-red-600 dark:text-red-400">Weak</span>
                                    </div>
                                </div>
                            </div>
                            <div class="prose prose-sm dark:prose-invert max-w-none">
                                <p>The RSI is currently in the oversold territory (below 30), which traditionally indicates a potential buying opportunity. However, in strong downtrends, RSI can remain oversold for extended periods. The current RSI of 25.6 suggests the stock is oversold, but confirmation from other indicators is recommended before making a trading decision.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Moving Averages -->
                    <div class="analysis-card">
                        <div class="flex items-center justify-between cursor-pointer" data-toggle="ma-analysis">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-line text-blue-500"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Moving Averages</h4>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform" id="ma-arrow"></i>
                        </div>
                        <div id="ma-analysis" class="mt-4 pl-13 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">20-Day MA</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">$5.25</div>
                                    <p class="text-xs text-red-600 dark:text-red-400 mt-1">-7.2% vs current</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">50-Day MA</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">$6.36</div>
                                    <p class="text-xs text-red-600 dark:text-red-400 mt-1">-23.4% vs current</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">200-Day MA</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">$4.12</div>
                                    <p class="text-xs text-green-600 dark:text-green-400 mt-1">+18.2% vs current</p>
                                </div>
                            </div>
                            <div class="prose prose-sm dark:prose-invert max-w-none">
                                <p>The stock is currently trading below both its 20-day and 50-day moving averages, indicating a bearish trend in the short to medium term. However, it remains above the 200-day moving average, which could act as a support level. The 20-day MA recently crossed below the 50-day MA, which is typically considered a bearish signal (Death Cross).</p>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Analysis -->
                    <div class="analysis-card">
                        <div class="flex items-center justify-between cursor-pointer" data-toggle="volume-analysis">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-pie text-blue-500"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Volume Analysis</h4>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform" id="volume-arrow"></i>
                        </div>
                        <div id="volume-analysis" class="mt-4 pl-13 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Today's Volume</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">60.5M</div>
                                    <p class="text-xs text-green-600 dark:text-green-400 mt-1">+36% vs avg</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Volume Ratio</p>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">1.36x</div>
                                    <p class="text-xs text-green-600 dark:text-green-400 mt-1">Above average</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Volume Trend</p>
                                    <div class="flex items-center">
                                        <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                        <span class="text-lg font-bold text-green-600 dark:text-green-400">Increasing</span>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Last 5 days</p>
                                </div>
                            </div>
                            <div class="prose prose-sm dark:prose-invert max-w-none">
                                <p>Volume has been increasing over the past few days, with today's volume 36% above the 15-day average. The rising volume on down days suggests strong selling pressure, but the recent increase in volume could also indicate capitulation, which often precedes a reversal. The volume profile shows significant support around the $4.70 level.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="addToWatchlistBottom" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    <i class="far fa-star mr-2"></i> Add to Watchlist
                </button>
                <button id="setPriceAlert" class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600 transition-colors duration-200">
                    <i class="fas fa-bell mr-2"></i> Set Price Alert
                </button>
                <button id="viewAdvancedCharts" class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600 transition-colors duration-200">
                    <i class="fas fa-chart-candlestick mr-2"></i> Advanced Charts
                </button>
            </div>

            <!-- Analysis Output -->
            <div class="analysis-output bg-gray-50 dark:bg-gray-700/30 rounded-lg p-4" id="analysisOutput">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Stock Analysis</h3>
                    <button id="addToWatchlist" 
                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 transition-colors duration-200"
                            data-ticker="">
                        <i class="far fa-star mr-1"></i> Add to Watchlist
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Price Summary</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">Open</span>
                                    <span id="openPrice" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">High</span>
                                    <span id="highPrice" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">Low</span>
                                    <span id="lowPrice" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">Close</span>
                                    <span id="closePrice" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Technical Indicators</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">RSI (14)</span>
                                    <span id="rsiValue" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">MACD</span>
                                    <span id="macdValue" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">SMA (50)</span>
                                    <span id="sma50" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">SMA (200)</span>
                                    <span id="sma200" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Analysis</h4>
                        <div id="analysisText" class="prose prose-sm dark:prose-invert max-w-none">
                            Run an analysis to see detailed results
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 p-4 mb-6 rounded-lg hidden transition-all duration-300">
            <div class="flex items-start">
                <div class="flex-shrink-0 pt-0.5">
                    <i class="fas fa-exclamation-triangle h-5 w-5 text-red-500 dark:text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800 dark:text-red-100">Error Processing Request</h3>
                    <div class="mt-1 text-sm text-red-700 dark:text-red-200" id="errorMessage"></div>
                    <div class="mt-2">
                        <button type="button" onclick="document.getElementById('error').classList.add('hidden')" 
                                class="text-sm font-medium text-red-800 dark:text-red-200 hover:text-red-900 dark:hover:text-red-100 focus:outline-none">
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="errorMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- Form Scripts -->
    <script>
        // Initialize chart and state variables
        let chart;
        let currentTicker = '';
        let currentTimeframe = '1m';
        
        // Toggle analysis sections
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle analysis sections
            document.querySelectorAll('[data-toggle]').forEach(button => {
                button.addEventListener('click', function(e) {
                    // Prevent event if clicking on form elements
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') {
                        return;
                    }
                    
                    const targetId = this.getAttribute('data-toggle');
                    const target = document.getElementById(targetId);
                    const arrow = this.querySelector('i.fa-chevron-down') || 
                                document.getElementById(`${targetId.split('-')[0]}-arrow`);
                    
                    if (target && arrow) {
                        target.classList.toggle('hidden');
                        arrow.classList.toggle('rotate-180');
                    }
                });
            });
            
            // Chart tab switching
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');
                    
                    // Update active tab styling
                    document.querySelectorAll('.chart-tab').forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                        t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200');
                    });
                    
                    this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200');
                    this.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    
                    // Update chart with new data
                    if (currentTicker) {
                        updateChartForTab(tabType);
                    }
                });
            });
            
            // Timeframe selection
            document.getElementById('timeframe').addEventListener('change', function() {
                currentTimeframe = this.value;
                if (currentTicker) {
                    fetchChartData(currentTicker, currentTimeframe);
                }
            });
            
            // Quick timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timeframe = this.getAttribute('data-timeframe');
                    document.getElementById('timeframe').value = timeframe;
                    currentTimeframe = timeframe;
                    if (currentTicker) {
                        fetchChartData(currentTicker, currentTimeframe);
                    }
                });
            });
            
            // Fullscreen chart
            document.getElementById('fullscreenChart').addEventListener('click', toggleFullscreen);
            
            // Reset zoom
            document.getElementById('resetZoom').addEventListener('click', resetChartZoom);
        });
        
        // Fetch chart data from the server
        async function fetchChartData(ticker, timeframe) {
            const chartLoading = document.getElementById('chartLoading');
            const analysisLoading = document.getElementById('analysisLoading');
            
            chartLoading.classList.remove('hidden');
            analysisLoading.classList.remove('hidden');
            
            try {
                // Update the ticker display
                document.getElementById('tickerDisplay').textContent = ticker;
                
                // Fetch chart data
                const [chartResponse, analysisResponse] = await Promise.all([
                    fetch(`/api/chart-data/${ticker}?timeframe=${timeframe}`),
                    fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `ticker=${ticker}&days=90`
                    })
                ]);
                
                const chartData = await chartResponse.json();
                const analysisData = await analysisResponse.json();
                
                if (chartData.error) {
                    throw new Error(chartData.error);
                }
                
                if (analysisData.error) {
                    console.error('Analysis error:', analysisData.error);
                    // Don't throw, we can still show the chart
                }
                
                updateChart(chartData);
                updateMetrics(chartData.metrics);
                
                // Update the analysis section if we have analysis data
                if (analysisData.analysis) {
                    document.getElementById('analysisOutput').textContent = analysisData.analysis;
                }
                
                // Update the current ticker
                currentTicker = ticker;
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to load data. Please try again.');
            } finally {
                chartLoading.classList.add('hidden');
                analysisLoading.classList.add('hidden');
            }
        }
        
        // Update chart for the active tab
        function updateChartForTab(tabType) {
            if (!chart) return;
            
            // This would be implemented based on your charting library
            // For example, with Chart.js you might do:
            // chart.config.type = getChartTypeForTab(tabType);
            // chart.update();
            
            // Placeholder for actual implementation
            console.log(`Switching to ${tabType} chart`);
        }
        
        // Update metrics display
        function updateMetrics(metrics) {
            if (!metrics) return;
            
            // Price and change
            if (metrics.currentPrice !== undefined) {
                document.getElementById('currentPrice').textContent = `$${metrics.currentPrice.toFixed(2)}`;
            }
            
            if (metrics.priceChange !== undefined) {
                const changeElement = document.getElementById('priceChange');
                changeElement.textContent = `${metrics.priceChange >= 0 ? '+' : ''}${metrics.priceChange.toFixed(2)}%`;
                changeElement.className = `ml-3 px-2.5 py-1 rounded-full text-sm font-medium ${
                    metrics.priceChange >= 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200'
                } flex items-center`;
            }
            
            // RSI
            if (metrics.rsi !== undefined) {
                document.getElementById('rsiValue').textContent = metrics.rsi.toFixed(1);
                const rsiStatus = document.querySelector('[data-toggle="rsi-analysis"] .bg-red-100');
                if (rsiStatus) {
                    if (metrics.rsi > 70) {
                        rsiStatus.textContent = 'Overbought';
                        rsiStatus.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-200 mr-3';
                    } else if (metrics.rsi < 30) {
                        rsiStatus.textContent = 'Oversold';
                        rsiStatus.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 mr-3';
                    } else {
                        rsiStatus.textContent = 'Neutral';
                        rsiStatus.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-200 mr-3';
                    }
                }
            }
            
            // Moving Averages
            if (metrics.ma50 !== undefined) {
                document.getElementById('fiftyDayMA').textContent = `$${metrics.ma50.toFixed(2)}`;
            }
            
            if (metrics.ma200 !== undefined) {
                document.getElementById('twoHundredDayMA').textContent = `$${metrics.ma200.toFixed(2)}`;
            }
            
            // Update signal counts if available
            if (metrics.buySignals !== undefined) {
                document.getElementById('buySignalCount').textContent = metrics.buySignals;
            }
            
            if (metrics.sellSignals !== undefined) {
                document.getElementById('sellSignalCount').textContent = metrics.sellSignals;
            }
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = `As of ${new Date().toLocaleTimeString()}`;
        }
        
        // Toggle fullscreen for chart
        function toggleFullscreen() {
            const chartContainer = document.getElementById('chart-container');
            
            if (!document.fullscreenElement) {
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.webkitRequestFullscreen) { /* Safari */
                    chartContainer.webkitRequestFullscreen();
                } else if (chartContainer.msRequestFullscreen) { /* IE11 */
                    chartContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            }
        }
        
        // Reset chart zoom
        function resetChartZoom() {
            if (chart && chart.resetZoom) {
                chart.resetZoom();
            }
        }
        
        // Update technical analysis data
        function updateTechnicalAnalysisData(chartData, ticker) {
            console.log(`Updating technical analysis for ${ticker}`, chartData);
            
            // Update RSI values if available
            if (chartData.rsi && chartData.rsi.length > 0) {
                const currentRSI = chartData.rsi[chartData.rsi.length - 1];
                const rsiElements = document.querySelectorAll('#rsi-analysis .text-2xl.font-bold');
                if (rsiElements.length > 0) {
                    rsiElements[0].textContent = currentRSI.toFixed(1);
                }
                
                // Calculate 14-day average RSI
                const last14RSI = chartData.rsi.slice(-14);
                const avgRSI = last14RSI.reduce((a, b) => a + b, 0) / last14RSI.length;
                if (rsiElements.length > 1) {
                    rsiElements[1].textContent = avgRSI.toFixed(1);
                }
                
                // Update RSI status
                const rsiStatusElement = document.querySelector('[data-toggle="rsi-analysis"] .px-2\\.5');
                if (rsiStatusElement) {
                    if (currentRSI > 70) {
                        rsiStatusElement.textContent = 'Overbought';
                        rsiStatusElement.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-200 mr-3';
                    } else if (currentRSI < 30) {
                        rsiStatusElement.textContent = 'Oversold';
                        rsiStatusElement.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 mr-3';
                    } else {
                        rsiStatusElement.textContent = 'Neutral';
                        rsiStatusElement.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-200 mr-3';
                    }
                }
                
                // Update signal strength bar
                const strengthBar = document.querySelector('#rsi-analysis .bg-red-500');
                const strengthText = document.querySelector('#rsi-analysis .text-red-600');
                if (strengthBar && strengthText) {
                    let strength, color, text;
                    if (currentRSI > 70 || currentRSI < 30) {
                        strength = Math.abs(currentRSI - 50) * 2; // 0-100 scale
                        color = currentRSI > 70 ? 'bg-purple-500' : 'bg-red-500';
                        text = strength > 60 ? 'Strong' : 'Moderate';
                    } else {
                        strength = 100 - Math.abs(currentRSI - 50) * 2;
                        color = 'bg-gray-500';
                        text = 'Weak';
                    }
                    strengthBar.style.width = `${Math.min(strength, 100)}%`;
                    strengthBar.className = `${color} h-2.5 rounded-full`;
                    strengthText.textContent = text;
                }
            }
            
            // Update moving averages if available
            if (chartData.ma50 && chartData.ma50.length > 0) {
                const currentMA50 = chartData.ma50[chartData.ma50.length - 1];
                const ma50Elements = document.querySelectorAll('#ma-analysis .text-2xl.font-bold');
                if (ma50Elements.length >= 2 && currentMA50 > 0) {
                    ma50Elements[1].textContent = `$${currentMA50.toFixed(2)}`;  // 50-day MA is the second element
                }
            }
            
            if (chartData.ma200 && chartData.ma200.length > 0) {
                const currentMA200 = chartData.ma200[chartData.ma200.length - 1];
                const ma200Elements = document.querySelectorAll('#ma-analysis .text-2xl.font-bold');
                if (ma200Elements.length >= 3 && currentMA200 > 0) {
                    ma200Elements[2].textContent = `$${currentMA200.toFixed(2)}`;  // 200-day MA is the third element
                }
            }
            
            // Calculate and update 20-day MA from price data
            if (chartData.prices && chartData.prices.length >= 20) {
                const last20Prices = chartData.prices.slice(-20);
                const ma20 = last20Prices.reduce((a, b) => a + b, 0) / last20Prices.length;
                const ma20Elements = document.querySelectorAll('#ma-analysis .text-2xl.font-bold');
                if (ma20Elements.length >= 1) {
                    ma20Elements[0].textContent = `$${ma20.toFixed(2)}`;  // 20-day MA is the first element
                }
            }
            
            // Update MA trend analysis and percentage comparisons
            if (chartData.prices && chartData.ma50 && chartData.ma200) {
                const currentPrice = chartData.prices[chartData.prices.length - 1];
                const currentMA50 = chartData.ma50[chartData.ma50.length - 1];
                const currentMA200 = chartData.ma200[chartData.ma200.length - 1];
                
                // Calculate 20-day MA for comparison
                const last20Prices = chartData.prices.slice(-20);
                const ma20 = last20Prices.reduce((a, b) => a + b, 0) / last20Prices.length;
                
                // Update percentage comparisons
                const ma20Comparison = ((currentPrice - ma20) / ma20 * 100).toFixed(1);
                const ma50Comparison = ((currentPrice - currentMA50) / currentMA50 * 100).toFixed(1);
                const ma200Comparison = ((currentPrice - currentMA200) / currentMA200 * 100).toFixed(1);
                
                // Update the percentage text elements
                const comparisonElements = document.querySelectorAll('#ma-analysis .text-xs');
                if (comparisonElements.length >= 3) {
                    comparisonElements[0].textContent = `${ma20Comparison >= 0 ? '+' : ''}${ma20Comparison}% vs current`;
                    comparisonElements[0].className = `text-xs ${ma20Comparison >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} mt-1`;
                    
                    comparisonElements[1].textContent = `${ma50Comparison >= 0 ? '+' : ''}${ma50Comparison}% vs current`;
                    comparisonElements[1].className = `text-xs ${ma50Comparison >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} mt-1`;
                    
                    comparisonElements[2].textContent = `${ma200Comparison >= 0 ? '+' : ''}${ma200Comparison}% vs current`;
                    comparisonElements[2].className = `text-xs ${ma200Comparison >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} mt-1`;
                }
                
                const maTrendElement = document.querySelector('#ma-analysis .prose p');
                if (maTrendElement && currentMA50 > 0 && currentMA200 > 0) {
                    let trendText = '';
                    if (currentPrice > currentMA50 && currentMA50 > currentMA200) {
                        trendText = `Strong bullish trend: Price ($${currentPrice.toFixed(2)}) is above both moving averages, with 50-day MA ($${currentMA50.toFixed(2)}) above 200-day MA ($${currentMA200.toFixed(2)}). This indicates strong upward momentum.`;
                    } else if (currentPrice < currentMA50 && currentMA50 < currentMA200) {
                        trendText = `Strong bearish trend: Price ($${currentPrice.toFixed(2)}) is below both moving averages, with 50-day MA ($${currentMA50.toFixed(2)}) below 200-day MA ($${currentMA200.toFixed(2)}). This indicates strong downward momentum.`;
                    } else if (currentPrice > currentMA50) {
                        trendText = `Mixed trend: Price ($${currentPrice.toFixed(2)}) is above 50-day MA ($${currentMA50.toFixed(2)}) but below 200-day MA ($${currentMA200.toFixed(2)}). Watch for confirmation signals.`;
                    } else {
                        trendText = `Bearish bias: Price ($${currentPrice.toFixed(2)}) is below 50-day MA ($${currentMA50.toFixed(2)}). Consider waiting for better entry points.`;
                    }
                    maTrendElement.textContent = trendText;
                }
            }
            
            // Update volume data if available
            if (chartData.volumes && chartData.volumes.length > 0) {
                const currentVolume = chartData.volumes[chartData.volumes.length - 1];
                const volumeElements = document.querySelectorAll('#volume-analysis .text-2xl.font-bold');
                if (volumeElements.length > 0) {
                    if (currentVolume >= 1000000) {
                        volumeElements[0].textContent = `${(currentVolume / 1000000).toFixed(1)}M`;
                    } else if (currentVolume >= 1000) {
                        volumeElements[0].textContent = `${(currentVolume / 1000).toFixed(1)}K`;
                    } else {
                        volumeElements[0].textContent = currentVolume.toLocaleString();
                    }
                }
                
                // Calculate average volume for comparison
                const last20Volumes = chartData.volumes.slice(-20);
                const avgVolume = last20Volumes.reduce((a, b) => a + b, 0) / last20Volumes.length;
                if (volumeElements.length > 1) {
                    if (avgVolume >= 1000000) {
                        volumeElements[1].textContent = `${(avgVolume / 1000000).toFixed(1)}M`;
                    } else if (avgVolume >= 1000) {
                        volumeElements[1].textContent = `${(avgVolume / 1000).toFixed(1)}K`;
                    } else {
                        volumeElements[1].textContent = avgVolume.toLocaleString();
                    }
                }
            }
            
            console.log(`Technical analysis updated for ${ticker}`);
        }
        
        // Format price with proper decimal places
        function formatPrice(price) {
            if (price === null || price === undefined || isNaN(price)) {
                return '$0.00';
            }
            
            // Use appropriate decimal places based on price magnitude
            let decimals = 2;
            if (price < 0.01) {
                decimals = 6;
            } else if (price < 0.1) {
                decimals = 4;
            } else if (price < 1) {
                decimals = 3;
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(Number(price));
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            // Chart colors for light/dark mode
            const colors = {
                light: {
                    text: '#374151',
                    grid: 'rgba(0, 0, 0, 0.05)',
                    border: '#d1d5db',
                    tooltipBg: 'rgba(0, 0, 0, 0.9)',
                    tooltipText: '#ffffff',
                },
                dark: {
                    text: '#d1d5db',
                    grid: 'rgba(255, 255, 255, 0.08)',
                    border: '#9ca3af',
                    tooltipBg: 'rgba(17, 24, 39, 0.95)',
                    tooltipText: '#e5e7eb',
                }
            };
            
            const theme = isDarkMode ? colors.dark : colors.light;
            
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        borderJoinStyle: 'round',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                                onZoomComplete: ({ chart }) => {
                                    chart.update('none');
                                }
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                                threshold: 10
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: theme.tooltipBg,
                            titleColor: theme.tooltipText,
                            bodyColor: theme.tooltipText,
                            titleFont: { 
                                size: 14, 
                                weight: 'bold',
                                family: "'Inter', 'Helvetica Neue', 'Arial', sans-serif"
                            },
                            bodyFont: { 
                                size: 13,
                                family: "'Inter', 'Helvetica Neue', 'Arial', sans-serif"
                            },
                            padding: 12,
                            usePointStyle: true,
                            cornerRadius: 6,
                            borderColor: theme.border,
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null && context.parsed.y !== undefined) {
                                        label += formatPrice(context.parsed.y);
                                    }
                                    return label;
                                },
                                title: function(context) {
                                    // Format date for tooltip title
                                    if (context && context[0] && context[0].label) {
                                        const date = new Date(context[0].label);
                                        if (!isNaN(date.getTime())) {
                                            return date.toLocaleDateString('en-US', {
                                                year: 'numeric',
                                                month: 'short',
                                                day: 'numeric'
                                            });
                                        }
                                    }
                                    return context[0].label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                color: theme.text,
                                font: { 
                                    size: 12,
                                    family: "'Inter', 'Helvetica Neue', 'Arial', sans-serif"
                                },
                                padding: 20,
                                usePointStyle: true,
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { 
                                display: true,
                                color: theme.grid,
                                drawBorder: true,
                                drawOnChartArea: true,
                                drawTicks: true,
                                borderColor: theme.border,
                            },
                            ticks: {
                                color: theme.text,
                                maxRotation: 0,
                                maxTicksLimit: 8,
                                font: {
                                    family: "'Inter', 'Helvetica Neue', 'Arial', sans-serif"
                                }
                            }
                        },
                        y: {
                            position: 'right',
                            grid: { 
                                color: theme.grid,
                                drawBorder: true,
                                borderColor: theme.border,
                            },
                            ticks: {
                                color: theme.text,
                                font: {
                                    size: 11,
                                    weight: '500',
                                    family: "'Inter', 'Helvetica Neue', 'Arial', sans-serif"
                                },
                                callback: function(value) {
                                    return formatPrice(value);
                                },
                                padding: 8,
                                maxTicksLimit: 8
                            },
                            border: {
                                display: true,
                                color: theme.border,
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 0
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.1,
                            borderWidth: 2,
                            borderCapStyle: 'round',
                        },
                        point: {
                            radius: 0,
                            hitRadius: 8,
                            hoverRadius: 5,
                            hoverBorderWidth: 2
                        }
                    }
                }
            });
        }
        
        // Update chart with new data
        function updateChart(data, type = 'price') {
            if (!stockChart) return;
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const theme = {
                light: { 
                    text: '#374151', 
                    grid: 'rgba(0, 0, 0, 0.05)', 
                    border: '#d1d5db',
                    tooltipBg: 'rgba(0, 0, 0, 0.9)',
                    tooltipText: '#ffffff'
                },
                dark: { 
                    text: '#d1d5db', 
                    grid: 'rgba(255, 255, 255, 0.08)', 
                    border: '#9ca3af',
                    tooltipBg: 'rgba(17, 24, 39, 0.95)',
                    tooltipText: '#e5e7eb'
                }
            }[isDarkMode ? 'dark' : 'light'];
            
            const datasets = [];
            let yAxisID = 'y';
            
            // Common dataset options
            const baseOptions = {
                borderWidth: 2,
                pointRadius: 0,
                borderJoinStyle: 'round',
                tension: 0.1
            };
            
            if (type === 'price') {
                datasets.push({
                    ...baseOptions,
                    label: 'Price',
                    data: data.prices,
                    borderColor: '#3b82f6',
                    backgroundColor: isDarkMode ? 'rgba(59, 130, 246, 0.15)' : 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                });
                yAxisID = 'y';
            } else if (type === 'volume') {
                datasets.push({
                    ...baseOptions,
                    label: 'Volume',
                    data: data.volumes || [],
                    borderColor: isDarkMode ? '#10b981' : '#059669',
                    backgroundColor: isDarkMode ? 'rgba(16, 185, 129, 0.15)' : 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    yAxisID: 'y',
                    borderWidth: 1
                });
                yAxisID = 'y';
            } else if (type === 'rsi') {
                datasets.push({
                    ...baseOptions,
                    label: 'RSI',
                    data: data.rsi || [],
                    borderColor: '#8b5cf6',
                    backgroundColor: isDarkMode ? 'rgba(139, 92, 246, 0.15)' : 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    yAxisID: 'y',
                });
                yAxisID = 'y';
            } else if (type === 'macd') {
                const positiveColor = isDarkMode ? 'rgba(16, 185, 129, 0.8)' : 'rgba(16, 185, 129, 0.7)';
                const negativeColor = isDarkMode ? 'rgba(239, 68, 68, 0.8)' : 'rgba(239, 68, 68, 0.7)';
                
                datasets.push(
                    {
                        ...baseOptions,
                        label: 'MACD Line',
                        data: data.macdLine || [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        ...baseOptions,
                        label: 'Signal Line',
                        data: data.signalLine || [],
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        ...baseOptions,
                        label: 'Histogram',
                        data: data.histogram || [],
                        type: 'bar',
                        backgroundColor: (data.histogram || []).map(value => 
                            value >= 0 ? positiveColor : negativeColor
                        ),
                        borderColor: 'transparent',
                        borderWidth: 0,
                        yAxisID: 'y',
                        barPercentage: 0.8,
                        categoryPercentage: 0.8,
                        borderRadius: 2
                    }
                );
                yAxisID = 'y';
            }
            
            // Update chart data
            stockChart.data.labels = data.dates;
            stockChart.data.datasets = datasets;
            
            // Update y-axis configuration
            const yAxis = stockChart.options.scales.y;
            yAxis.display = true;
            yAxis.ticks.color = theme.text;
            yAxis.grid.color = theme.grid;
            yAxis.border.color = theme.border;
            
            // Configure y-axis based on chart type
            if (type === 'price') {
                yAxis.position = 'right';
                yAxis.ticks.callback = function(value) {
                    return formatPrice(value);
                };
                yAxis.grid.drawBorder = true;
            } else if (type === 'volume') {
                yAxis.position = 'right';
                yAxis.ticks.callback = function(value) {
                    if (value >= 1000000000) {
                        return (value / 1000000000).toFixed(1) + 'B';
                    } else if (value >= 1000000) {
                        return (value / 1000000).toFixed(1) + 'M';
                    } else if (value >= 1000) {
                        return (value / 1000).toFixed(1) + 'K';
                    }
                    return value.toLocaleString();
                };
                yAxis.grid.drawBorder = true;
            } else if (type === 'rsi') {
                yAxis.min = 0;
                yAxis.max = 100;
                yAxis.ticks.callback = function(value) {
                    return value;
                };
                yAxis.grid.drawBorder = true;
            } else if (type === 'macd') {
                yAxis.position = 'right';
                yAxis.ticks.callback = function(value) {
                    return value.toFixed(2);
                };
                yAxis.grid.drawBorder = true;
            }
            
            // Update x-axis styling
            const xAxis = stockChart.options.scales.x;
            xAxis.ticks.color = theme.text;
            xAxis.grid.color = theme.grid;
            xAxis.border.color = theme.border;
            
            // Update legend styling
            stockChart.options.plugins.legend.labels.color = theme.text;
            
            // Update tooltip colors based on theme
            stockChart.options.plugins.tooltip.backgroundColor = theme.tooltipBg;
            stockChart.options.plugins.tooltip.titleColor = theme.tooltipText;
            stockChart.options.plugins.tooltip.bodyColor = theme.tooltipText;
            
            // Apply updates with animation
            stockChart.update({
                duration: 0,
                lazy: true
            });
        }
        
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-200');
                });
                
                this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-200');
                this.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                
                // Update chart data based on tab
                if (chartData) {
                    document.getElementById('chartLoading').classList.remove('hidden');
                    
                    // Simulate loading (in real app, this would fetch new data)
                    setTimeout(() => {
                        updateChart(chartData, tab);
                        document.getElementById('chartLoading').classList.add('hidden');
                    }, 300);
                }
            });
        });
        
        // Watchlist functionality
        class Watchlist {
            constructor() {
                this.items = new Set(JSON.parse(localStorage.getItem('watchlist') || '[]'));
                this.updateUI();
                this.setupEventListeners();
            }
            
            add(ticker) {
                if (!ticker) return;
                this.items.add(ticker.toUpperCase());
                this.save();
                this.updateUI();
                this.showNotification(`Added ${ticker} to watchlist`);
            }
            
            remove(ticker) {
                this.items.delete(ticker);
                this.save();
                this.updateUI();
                this.showNotification(`Removed ${ticker} from watchlist`);
            }
            
            clear() {
                this.items.clear();
                this.save();
                this.updateUI();
                this.showNotification('Watchlist cleared');
            }
            
            has(ticker) {
                return this.items.has(ticker.toUpperCase());
            }
            
            save() {
                localStorage.setItem('watchlist', JSON.stringify([...this.items]));
            }
            
            updateUI() {
                const watchlistItems = document.getElementById('watchlistItems');
                const watchlistCount = document.getElementById('watchlistCount');
                
                if (this.items.size === 0) {
                    watchlistItems.innerHTML = `
                        <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                            No stocks in watchlist
                        </div>`;
                    watchlistCount.classList.add('hidden');
                    return;
                }
                
                watchlistCount.textContent = this.items.size;
                watchlistCount.classList.remove('hidden');
                
                let itemsHTML = '';
                this.items.forEach(ticker => {
                    itemsHTML += `
                        <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <button class="text-left flex-1 py-1 hover:text-blue-600 dark:hover:text-blue-400" 
                                    onclick="document.getElementById('ticker').value='${ticker}'; document.getElementById('analysisForm').dispatchEvent(new Event('submit'));">
                                ${ticker}
                            </button>
                            <button class="text-red-500 hover:text-red-700 p-1" onclick="watchlist.remove('${ticker}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>`;
                });
                
                watchlistItems.innerHTML = itemsHTML;
                
                // Update add to watchlist button in results
                const addToWatchlistBtn = document.getElementById('addToWatchlist');
                if (addToWatchlistBtn) {
                    const ticker = addToWatchlistBtn.getAttribute('data-ticker');
                    if (this.has(ticker)) {
                        addToWatchlistBtn.innerHTML = '<i class="fas fa-star"></i> In Watchlist';
                        addToWatchlistBtn.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/30', 'dark:text-yellow-400');
                        addToWatchlistBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'dark:bg-gray-700', 'dark:hover:bg-gray-600');
                    } else {
                        addToWatchlistBtn.innerHTML = '<i class="far fa-star"></i> Add to Watchlist';
                        addToWatchlistBtn.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/30', 'dark:text-yellow-400');
                        addToWatchlistBtn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'dark:bg-gray-700', 'dark:hover:bg-gray-600');
                    }
                }
            }
            
            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg flex items-center';
                notification.innerHTML = `
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            setupEventListeners() {
                // Clear watchlist button
                document.getElementById('clearWatchlist')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to clear your watchlist?')) {
                        this.clear();
                    }
                });
                
                // Close watchlist when clicking outside
                document.addEventListener('click', (e) => {
                    const watchlistButton = document.getElementById('watchlistButton');
                    if (!watchlistButton.contains(e.target)) {
                        const dropdown = watchlistButton.querySelector('span[class*="group-hover:block"]');
                        if (dropdown) {
                            dropdown.classList.add('hidden');
                            dropdown.classList.remove('block');
                        }
                    }
                });
            }
        }
        
        // Initialize watchlist
        const watchlist = new Watchlist();
        
        // Toggle watchlist dropdown
        document.getElementById('watchlistButton').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = e.currentTarget.querySelector('span[class*="group-hover:block"]');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                dropdown.classList.toggle('block');
            }
        });
        
        // Initialize chart when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
        });
        
        // Toggle custom days input
        const daysSelect = document.getElementById('days');
        const customDaysContainer = document.getElementById('customDaysContainer');
        
        daysSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDaysContainer.classList.remove('hidden');
                customDaysContainer.classList.add('block');
            } else {
                customDaysContainer.classList.remove('block');
                customDaysContainer.classList.add('hidden');
            }
        });
        
        // Auto-uppercase ticker input
        const tickerInput = document.getElementById('ticker');
        tickerInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            // Clear any validation errors
            this.setCustomValidity('');
        });
        
        // Override form validation completely
        tickerInput.addEventListener('invalid', function(e) {
            e.preventDefault();
            console.log('Validation error prevented:', e);
        });
    </script>
    
    <!-- Theme Toggle Script -->
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        // Check for saved theme preference or use system preference
        const savedTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        // Apply saved theme
        if (savedTheme === 'dark') {
            html.classList.add('dark');
            themeToggle.innerHTML = '<i class="fas fa-sun text-yellow-300 text-xl"></i>';
        } else {
            html.classList.remove('dark');
            themeToggle.innerHTML = '<i class="fas fa-moon text-gray-600 text-xl"></i>';
        }
        
        // Toggle theme on button click
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.innerHTML = isDark 
                ? '<i class="fas fa-sun text-yellow-300 text-xl"></i>' 
                : '<i class="fas fa-moon text-gray-600 text-xl">';
        });
    </script>

    <!-- Debug Information -->
    <div class="mt-8 p-4 bg-gray-100 rounded-lg text-xs text-gray-600">
        <h3 class="font-bold mb-2">Debug Information:</h3>
        <p>Show Shutdown: {{ show_shutdown }}</p>
        {% if debug_info %}
        <p>Client IP: {{ debug_info.client_ip }}</p>
        <p>User Agent: {{ debug_info.user_agent }}</p>
        {% endif %}
    </div>

    <!-- Shutdown button (always visible for now) -->
    <footer class="mt-6 text-center">
        <button 
            id="shutdownBtn" 
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full text-sm transition-colors duration-200"
            onclick="shutdownServer()">
            🛑 Shutdown Server
        </button>
    </footer>

    <script>
        // Shutdown server function
        async function shutdownServer() {
            if (confirm('Are you sure you want to shut down the server?')) {
                try {
                    // Show immediate feedback
                    document.getElementById('shutdownBtn').innerHTML = '⏳ Shutting down...';
                    document.getElementById('shutdownBtn').disabled = true;
                    
                    const response = await fetch('/shutdown');
                    
                    // If we get here, show the shutdown page
                    if (response.ok) {
                        const result = await response.text();
                        document.body.innerHTML = result;
                    }
                } catch (error) {
                    // This is expected when the server shuts down
                    document.body.innerHTML = `
                        <div style="font-family: Arial, sans-serif; text-align: center; margin-top: 50px;">
                            <h2>✅ Server has been shut down</h2>
                            <p>You can close this window now.</p>
                        </div>
                    `;
                }
            }
        }

        // Main form submission
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Completely disable HTML5 validation
            const form = e.target;
            form.noValidate = true;
            
            // Override any validation that might be triggered
            try {
                if (form.reportValidity) {
                    // Prevent reportValidity from being called
                    form.reportValidity = () => true;
                }
            } catch (validationError) {
                console.log('Validation override applied');
            }
            
            // Get form elements
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const days = document.getElementById('days').value === 'custom' ? 
                document.getElementById('customDays').value : document.getElementById('days').value;
            const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
            const results = document.getElementById('results');
            const loading = document.getElementById('loading');
            const loadingStatus = document.getElementById('loadingStatus');
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            // Set request timeout (10 seconds)
            const REQUEST_TIMEOUT = 30000; // 30 seconds
            let timeoutId;
            
            // Add to watchlist
            if (ticker) {
                watchlist.add(ticker);
            }
            
            // Update submit button
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Analyzing...
            `;
            
            // Reset UI
            results.classList.add('hidden');
            error.classList.add('hidden');
            loadingStatus.textContent = 'Fetching stock data...';
            loading.classList.remove('hidden');
            
            // Set timeout for the request
            timeoutId = setTimeout(() => {
                if (loading && !loading.classList.contains('hidden')) {
                    showError('Request is taking longer than expected. Please check your connection and try again.');
                    loading.classList.add('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <i class="fas fa-chart-line mr-2"></i>
                        Try Again
                    `;
                }
            }, REQUEST_TIMEOUT);
            
            try {
                console.log('Starting analysis for:', ticker);
                
                // Basic ticker validation
                if (!ticker || ticker.length === 0) {
                    throw new Error('Please enter a stock ticker');
                }
                
                // Update loading status
                loadingStatus.textContent = 'Validating ticker...';
                
                // Force clear any browser validation state
                const tickerField = document.getElementById('ticker');
                tickerField.setCustomValidity('');
                
                // Check if form is valid without triggering validation
                if (!form.checkValidity()) {
                    console.log('Form validation bypassed');
                    // Force form to be valid
                    Array.from(form.elements).forEach(element => {
                        if (element.setCustomValidity) {
                            element.setCustomValidity('');
                        }
                    });
                }
                
                // Fetch chart data first
                // Fetch both chart data and analysis in parallel
                loadingStatus.textContent = 'Fetching data and running analysis...';
                console.log('Fetching chart data and analysis...');
                
                const [chartResponse, analysisResponse] = await Promise.all([
                    fetch(`/api/chart-data/${ticker}`),
                    fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `ticker=${ticker}&days=${days}`
                    })
                ]);
                
                console.log('Chart response status:', chartResponse.status);
                console.log('Analysis response status:', analysisResponse.status);
                
                if (!chartResponse.ok) {
                    const errorData = await chartResponse.json().catch(() => ({}));
                    throw new Error(errorData.error || `Failed to fetch chart data (${chartResponse.status})`);
                }
                
                const chartDataResponse = await chartResponse.json();
                const analysisData = await analysisResponse.json();
                
                console.log('Chart data received:', !!chartDataResponse);
                console.log('Analysis data received:', !!analysisData);
                
                chartData = chartDataResponse;
                updateChart(chartData, 'price');
                
                // Update stock ticker and name at the top
                document.getElementById('stockTicker').textContent = ticker;
                document.getElementById('companyName').textContent = `${ticker} - Stock Analysis`;
                
                // Update price metrics in the key metrics section
                if (chartData.prices && chartData.prices.length > 0) {
                    const currentPrice = chartData.prices[chartData.prices.length - 1];
                    const previousPrice = chartData.prices.length > 1 ? chartData.prices[chartData.prices.length - 2] : currentPrice;
                    const priceChange = currentPrice - previousPrice;
                    const percentChange = previousPrice !== 0 ? (priceChange / previousPrice) * 100 : 0;
                    
                    // Update current price
                    document.getElementById('currentPrice').textContent = `$${currentPrice.toFixed(2)}`;
                    document.getElementById('stockSymbol').textContent = ticker;
                    document.getElementById('stockName').textContent = `${ticker} Stock`;
                    
                    // Update price change
                    const priceChangeElement = document.getElementById('priceChange');
                    const percentChangeElement = document.getElementById('percentChange');
                    
                    priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}$${priceChange.toFixed(2)}`;
                    percentChangeElement.textContent = `${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(2)}%`;
                    
                    // Update colors based on change
                    const changeClass = priceChange >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    priceChangeElement.className = `text-lg font-semibold ${changeClass}`;
                    percentChangeElement.className = `text-lg font-semibold ${changeClass}`;
                }
                
                // Show/hide technical analysis section based on analysis type
                const technicalAnalysisSection = document.getElementById('technicalAnalysisSection');
                if (analysisType === 'basic') {
                    if (technicalAnalysisSection) {
                        technicalAnalysisSection.style.display = 'none';
                    }
                } else {
                    if (technicalAnalysisSection) {
                        technicalAnalysisSection.style.display = 'block';
                    }
                }
                
                // Update analysis section
                if (analysisData && analysisData.analysis) {
                    document.getElementById('analysisText').innerHTML = `<pre class="whitespace-pre-wrap text-sm">${analysisData.analysis}</pre>`;
                } else if (analysisData && analysisData.error) {
                    document.getElementById('analysisText').innerHTML = `<div class="text-red-600 dark:text-red-400">Analysis Error: ${analysisData.error}</div>`;
                }
                
                // Update technical analysis data if available
                if (chartData && analysisType !== 'basic') {
                    updateTechnicalAnalysisData(chartData, ticker);
                }
                
                // Clear any existing timeout
                if (timeoutId) clearTimeout(timeoutId);
                results.classList.remove('hidden');
                
                // Update watchlist button
                const addToWatchlistBtn = document.getElementById('addToWatchlist');
                if (addToWatchlistBtn) {
                    const isInWatchlist = watchlist.has(ticker);
                    addToWatchlistBtn.innerHTML = `
                        <i class="fas ${isInWatchlist ? 'fa-heart' : 'fa-heart-o'}"></i>
                        ${isInWatchlist ? 'Remove from' : 'Add to'} Watchlist
                    `;
                    addToWatchlistBtn.onclick = () => {
                        if (isInWatchlist) {
                            watchlist.remove(ticker);
                        } else {
                            watchlist.add(ticker);
                        }
                        // Update button after action
                        setTimeout(() => {
                            const newIsInWatchlist = watchlist.has(ticker);
                            addToWatchlistBtn.innerHTML = `
                                <i class="fas ${newIsInWatchlist ? 'fa-heart' : 'fa-heart-o'}"></i>
                                ${newIsInWatchlist ? 'Remove from' : 'Add to'} Watchlist
                            `;
                        }, 100);
                    };
                }
                
            } catch (err) {
                console.error('Analysis error:', err);
                
                // Clear any existing timeout
                if (timeoutId) clearTimeout(timeoutId);
                
                // User-friendly error messages
                let userMessage = 'An unexpected error occurred';
                
                if (err instanceof TypeError && err.message.includes('Failed to fetch')) {
                    userMessage = 'Unable to connect to the server. Please check your internet connection.';
                } else if (err.message.includes('404')) {
                    userMessage = 'Stock not found. Please check the ticker symbol and try again.';
                } else if (err.message) {
                    userMessage = err.message;
                }
                
                // Update error message
                if (errorMessage) {
                    errorMessage.textContent = userMessage;
                    error.classList.remove('hidden');
                    
                    // Auto-hide error after 10 seconds
                    setTimeout(() => {
                        error.classList.add('hidden');
                    }, 10000);
                }
            } finally {
                loading.classList.add('hidden');
                
                // Reset submit button
                submitButton.disabled = false;
                submitButton.innerHTML = `
                    <i class="fas fa-chart-line mr-2"></i>
                    Analyze Stock
                `;
                
                // Scroll to results or error
                const elementToScroll = error.classList.contains('hidden') ? results : error;
                elementToScroll.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>
</html>
