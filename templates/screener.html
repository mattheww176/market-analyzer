{% extends "base.html" %}

{% block title %}Stock Screener - Market Analyzer{% endblock %}

{% block content %}
<!-- Add the stocks data as a JSON string in a script tag -->
<script type="application/json" id="stocksData">
    {{ stocks|tojson|safe }}
</script>

<!-- Add the screener script -->
<script src="{{ url_for('static', filename='js/screener.js') }}"></script>

<!-- Initialize the stocks data -->
<script>
    // Parse the stocks data from the JSON element
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const stocksDataElement = document.getElementById('stocksData');
            if (stocksDataElement && stocksDataElement.textContent) {
                const stocks = JSON.parse(stocksDataElement.textContent);
                window._stocksData = Array.isArray(stocks) ? stocks : [];
                window.stocksData = window._stocksData; // Make sure this is set for filtering
                
                // Display the initial results
                if (typeof window.displayResults === 'function') {
                    window.displayResults(window.stocksData);
                }
            } else {
                console.error('No stocks data found');
                window._stocksData = [];
                window.stocksData = [];
            }
        } catch (e) {
            console.error('Error parsing stocks data:', e);
            window._stocksData = [];
            window.stocksData = [];
        }
    });
</script>
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Page Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Stock Screener</h1>
            <p class="text-gray-600 dark:text-gray-300">Filter and discover stocks based on your criteria</p>
        </div>

        <!-- Filter Controls -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Filter Stocks</h2>
            
            <form id="screenerForm" method="GET" action="#" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Price Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="minPrice" name="minPrice" placeholder="Min" 
                               class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <input type="number" id="maxPrice" name="maxPrice" placeholder="Max" 
                               class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                </div>

                <!-- Market Cap -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Market Cap</label>
                    <select id="marketCap" name="marketCap" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Any</option>
                        <option value="mega">Mega Cap ($200B+)</option>
                        <option value="large">Large Cap ($10B-$200B)</option>
                        <option value="mid">Mid Cap ($2B-$10B)</option>
                        <option value="small">Small Cap ($300M-$2B)</option>
                    </select>
                </div>

                <!-- Volume -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Min Volume</label>
                    <input type="number" id="minVolume" name="minVolume" placeholder="e.g., 1000000" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Sector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sector</label>
                    <select id="sector" name="sector" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">All Sectors</option>
                        <option value="Technology">Technology</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Financial Services">Financial Services</option>
                        <option value="Consumer Cyclical">Consumer Cyclical</option>
                        <option value="Industrials">Industrials</option>
                        <option value="Communication Services">Communication Services</option>
                        <option value="Consumer Defensive">Consumer Defensive</option>
                        <option value="Energy">Energy</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Real Estate">Real Estate</option>
                        <option value="Basic Materials">Basic Materials</option>
                    </select>
                </div>

                <!-- P/E Ratio -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max P/E Ratio</label>
                    <input type="number" id="maxPERatio" name="maxPERatio" placeholder="e.g., 25" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Dividend Yield -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Min Dividend Yield (%)</label>
                    <input type="number" step="0.1" id="minDividendYield" name="minDividendYield" placeholder="e.g., 2.5" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>

                <!-- 52-Week Change -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">52-Week Change</label>
                    <div class="flex space-x-2">
                        <input type="number" id="min52WeekChange" name="min52WeekChange" placeholder="Min %" 
                               class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <input type="number" id="max52WeekChange" name="max52WeekChange" placeholder="Max %" 
                               class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex items-end space-x-2 col-span-1 md:col-span-2 lg:col-span-4">
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-sm transition-colors duration-200">
                        Apply Filters
                    </button>
                    <button type="button" id="resetFilters"
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-md shadow-sm transition-colors duration-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white">
                        Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Loading stocks...</p>
        </div>

        <!-- Results Container -->
        <div id="screenerResultsTable" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stock</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Price</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Change</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Market Cap</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Volume</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">P/E</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Div Yield</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sector</th>
                        </tr>
                    </thead>
                    <tbody id="screenerResults" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Results will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Results Container (for compatibility) -->
        <div id="screenerResultsContainer" class="hidden"></div>
    </div>
</div>

<!-- Stock Row Template (Hidden) -->
<template id="stockRowTemplate">
    <tr class="hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <span class="ticker-symbol font-medium text-gray-900 dark:text-white"></span>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="current-price font-medium"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="price-change"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="percent-change"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="volume"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="market-cap"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex justify-end space-x-2">
                <button class="analyze-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" title="Analyze">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="add-to-watchlist-btn text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300" title="Add to Watchlist">
                    <i class="fas fa-plus-circle"></i>
                </button>
            </div>
        </td>
    </tr>
</template>

{% endblock %}
